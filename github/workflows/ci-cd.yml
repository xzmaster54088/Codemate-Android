name: CodeMate Mobile CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # æ¯å¤©å‡Œæ™¨2ç‚¹è¿è¡Œ
    - cron: '0 2 * * *'

env:
  JAVA_VERSION: '17'
  ANDROID_COMPILE_SDK: '34'
  ANDROID_BUILD_TOOLS_VERSION: '34.0.0'
  ANDROID_SDK_TOOLS: '10406996'

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æ£€æŸ¥ä»£ç æ ¼å¼ (ktlint)
        run: |
          curl -sSLO https://github.com/pinterest/ktlint/releases/latest/download/ktlint
          chmod a+x ktlint
          ./ktlint --reporter=plain app/src/main/java/**/*.kt

      - name: è¿è¡ŒDetekté™æ€åˆ†æ
        run: ./gradlew detekt

      - name: è¿è¡Œktlintä»£ç é£æ ¼æ£€æŸ¥
        run: ./gradlew ktlintCheck

      - name: æ‰«æä»£ç å®‰å…¨æ¼æ´
        uses: securecodewarrior/github-action-add-sarif@v1
        with:
          sarif-file: 'detekt/build/reports/detekt.sarif'

  # å•å…ƒæµ‹è¯•
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: è¿è¡Œå•å…ƒæµ‹è¯•
        run: ./gradlew test

      - name: ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: ./gradlew jacocoTestReport

      - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡åˆ°Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ç¼“å­˜æµ‹è¯•ç»“æœ
        uses: actions/cache@v3
        with:
          path: app/build/reports/tests
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

  # é›†æˆæµ‹è¯•
  integration-tests:
    name: é›†æˆæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [ unit-tests ]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: å¯åŠ¨Androidæ¨¡æ‹Ÿå™¨
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: pixel_4
          script: adb wait-for-device; adb shell input keyevent 82;

      - name: è¿è¡Œé›†æˆæµ‹è¯•
        run: ./gradlew connectedAndroidTest

      - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        if: always()
        run: ./gradlew createDebugCoverageReport

      - name: ä¸Šä¼ æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: app/build/reports/androidTests/connected

  # UIæµ‹è¯•
  ui-tests:
    name: UIæµ‹è¯•
    runs-on: ubuntu-latest
    needs: [ unit-tests ]
    strategy:
      matrix:
        api-level: [ 28, 30, 33 ]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: å¯åŠ¨Androidæ¨¡æ‹Ÿå™¨ (API ${{ matrix.api-level }})
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          arch: x86_64
          profile: pixel_4
          script: adb wait-for-device; adb shell input keyevent 82;

      - name: è¿è¡ŒUIæµ‹è¯•
        run: ./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.codemate.**.ui.**

      - name: ä¸Šä¼ UIæµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: ui-test-results-api-${{ matrix.api-level }}
          path: app/build/reports/androidTests/connected

  # æ€§èƒ½æµ‹è¯•
  performance-tests:
    name: æ€§èƒ½æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [ unit-tests ]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: å¯åŠ¨Androidæ¨¡æ‹Ÿå™¨
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          profile: pixel_4
          script: adb wait-for-device; adb shell input keyevent 82;

      - name: è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•
        run: ./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.codemate.**.performance.**

      - name: ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
        run: ./gradlew createPerformanceReport

      - name: ä¸Šä¼ æ€§èƒ½æµ‹è¯•ç»“æœ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results
          path: app/build/reports/performance

  # å®‰å…¨æ‰«æ
  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è¿è¡ŒSonarQubeæ‰«æ
        uses: sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

      - name: è¿è¡Œä¾èµ–å®‰å…¨æ‰«æ
        uses: github/codeql-action/init@v2
        with:
          languages: kotlin

      - name: è‡ªåŠ¨æ„å»º
        run: ./gradlew assembleDebug

      - name: æ‰§è¡ŒCodeQLåˆ†æ
        uses: github/codeql-action/analyze@v2

  # æ„å»ºåº”ç”¨
  build:
    name: æ„å»ºåº”ç”¨
    runs-on: ubuntu-latest
    needs: [ code-quality, unit-tests, integration-tests, ui-tests ]
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: è®¾ç½®Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: ${{ env.ANDROID_COMPILE_SDK }}
          build-tools: ${{ env.ANDROID_BUILD_TOOLS_VERSION }}

      - name: ç¼“å­˜Gradleä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: æ„å»ºDebug APK
        run: ./gradlew assembleDebug

      - name: æ„å»ºRelease APK
        run: ./gradlew assembleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: ç”ŸæˆAABæ–‡ä»¶
        run: ./gradlew bundleRelease
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v3
        with:
          name: app-builds
          path: |
            app/build/outputs/apk/debug/*.apk
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab

      - name: ç”Ÿæˆæ„å»ºæ‘˜è¦
        run: |
          echo "## ğŸ“± CodeMate Mobile æ„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- **è§¦å‘è€…**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # å‘å¸ƒåˆ°æµ‹è¯•
  deploy-staging:
    name: å‘å¸ƒåˆ°æµ‹è¯•ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [ build, security-scan ]
    if: github.ref == 'refs/heads/develop'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: app-builds
          path: app/build/outputs

      - name: å‘å¸ƒåˆ°Firebase App Distribution
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          groups: testers
          file: app/build/outputs/apk/debug/app-debug.apk
          releaseNotesFile: release-notes.txt

  # å‘å¸ƒåˆ°ç”Ÿäº§
  deploy-production:
    name: å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ
    runs-on: ubuntu-latest
    needs: [ build, security-scan ]
    if: github.ref == 'refs/heads/main'
    environment: production
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v3
        with:
          name: app-builds
          path: app/build/outputs

      - name: å‘å¸ƒåˆ°Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: com.codemate
          releaseFiles: app/build/outputs/bundle/release/app-release.aab
          track: internal

      - name: å‘å¸ƒåˆ°åä¸ºåº”ç”¨å¸‚åœº
        uses: huawei-appgallery-connect/appgallery-connect-apk-upload-github-action@v1
        with:
          client_id: ${{ secrets.HUAWEI_CLIENT_ID }}
          client_secret: ${{ secrets.HUAWEI_CLIENT_SECRET }}
          app_id: ${{ secrets.HUAWEI_APP_ID }}
          apk_file: app/build/outputs/apk/release/app-release.apk

  # éƒ¨ç½²åˆ°GitHub Pages
  deploy-docs:
    name: éƒ¨ç½²æ–‡æ¡£
    runs-on: ubuntu-latest
    needs: [ code-quality, unit-tests ]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: ç”ŸæˆAPIæ–‡æ¡£
        run: ./gradlew dokkaHtml

      - name: éƒ¨ç½²åˆ°GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: app/build/dokka/html

  # é€šçŸ¥
  notify:
    name: é€šçŸ¥
    runs-on: ubuntu-latest
    needs: [ deploy-staging, deploy-production, deploy-docs ]
    if: always()
    steps:
      - name: å‘é€æˆåŠŸé€šçŸ¥
        if: needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success'
        run: |
          echo "âœ… éƒ¨ç½²æˆåŠŸï¼"
          # å¯ä»¥é›†æˆSlackã€å¾®ä¿¡ã€é’‰é’‰ç­‰é€šçŸ¥æ–¹å¼

      - name: å‘é€å¤±è´¥é€šçŸ¥
        if: needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure'
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          # å¯ä»¥é›†æˆSlackã€å¾®ä¿¡ã€é’‰é’‰ç­‰é€šçŸ¥æ–¹å¼
